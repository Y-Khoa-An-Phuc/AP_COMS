<div class="occupation-view-container">
  <div class="occupation-view-card">

    <!-- Filter Bar -->
    <div class="filter-bar">

      <!-- Right: Action Buttons -->
      <div class="filter-right">
        <button mat-icon-button class="filter-icon-btn" cdkOverlayOrigin #filterTrigger="cdkOverlayOrigin" (click)="toggleFilterPanel()">
          <mat-icon>filter_alt</mat-icon>
        </button>
        <button mat-stroked-button class="actions-btn" [matMenuTriggerFor]="actionsMenu">
          Thao Tác
          <mat-icon>arrow_drop_down</mat-icon>
        </button>
        <mat-menu #actionsMenu="matMenu">
          <button mat-menu-item (click)="onExportExcel()">
            <mat-icon>upload</mat-icon>
            <span>Xuất Excel</span>
          </button>
          <button mat-menu-item (click)="onViewHistory()">
            <mat-icon>history</mat-icon>
            <span>Xem Lịch Sử</span>
          </button>
        </mat-menu>
        <button mat-raised-button class="add-btn" (click)="onAddOccupation()">
          Thêm Nghề Nghiệp
        </button>
      </div>

    </div>

    <!-- Error Message -->
    @if (errorMessage && !isLoading) {
      <div class="error-message-box">
        {{ errorMessage }}
      </div>
    }

    <!-- Loading Spinner -->
    @if (isLoading) {
      <div class="loading-container">
        <mat-icon class="loading-spinner">autorenew</mat-icon>
        <p>Đang tải danh sách nghề nghiệp...</p>
      </div>
    }

    <!-- Occupation Table -->
    @if (!isLoading) {
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" class="occupation-table">

        <!-- Edit Icon Column -->
        <ng-container matColumnDef="edit">
          <th mat-header-cell *matHeaderCellDef class="edit-column"></th>
          <td mat-cell *matCellDef="let occupation" class="edit-column">
            <button mat-icon-button class="edit-icon-btn" (click)="onEditOccupation(occupation)">
              <mat-icon class="edit-icon">edit</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Delete Icon Column -->
        <ng-container matColumnDef="delete">
          <th mat-header-cell *matHeaderCellDef class="delete-column"></th>
          <td mat-cell *matCellDef="let occupation" class="delete-column">
            <button mat-icon-button class="delete-icon-btn" (click)="onDeleteOccupation(occupation)">
              <mat-icon class="delete-icon">delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Checkbox Column -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef class="checkbox-column">
            <mat-checkbox (change)="onSelectAll($event.checked)" [checked]="isAllSelected()" [indeterminate]="isSomeSelected()"></mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let occupation" class="checkbox-column">
            <mat-checkbox (change)="onSelectOccupation(occupation, $event.checked)" [checked]="isSelected(occupation)"></mat-checkbox>
          </td>
        </ng-container>

        <!-- Occupation Code Column (Readonly) -->
        <ng-container matColumnDef="occCode">
          <th mat-header-cell *matHeaderCellDef>Mã Nghề Nghiệp</th>
          <td mat-cell *matCellDef="let occupation">
            <span class="occupation-code">{{occupation.occCode}}</span>
          </td>
        </ng-container>

        <!-- Occupation Name Column -->
        <ng-container matColumnDef="occName">
          <th mat-header-cell *matHeaderCellDef>Tên Nghề Nghiệp</th>
          <td mat-cell *matCellDef="let occupation">{{occupation.occName}}</td>
        </ng-container>

        <!-- Description Column -->
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Mô Tả</th>
          <td mat-cell *matCellDef="let occupation">{{occupation.description || '—'}}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="occupation-row"></tr>
      </table>
    </div>
    }

  </div>
</div>

<!-- Filter Panel Overlay -->
<ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="filterTrigger" [cdkConnectedOverlayOpen]="isFilterPanelOpen" (backdropClick)="closeFilterPanel()" [cdkConnectedOverlayHasBackdrop]="true" [cdkConnectedOverlayBackdropClass]="'cdk-overlay-transparent-backdrop'">
  <div class="filter-panel">
    <div class="filter-panel-content">
      <!-- Add Condition Dropdown -->
      <div class="filter-section">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Thêm điều kiện</mat-label>
          <mat-select (selectionChange)="onAddCondition($event.value); $event.source.value = null" [value]="null">
            <mat-option *ngFor="let column of availableFilterColumns" [value]="column.field">
              {{ column.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Filter Conditions -->
      <div class="filter-conditions">
        <div *ngFor="let condition of filterConditions; let i = index" class="filter-condition-block">
          <div class="condition-header">
            <span class="condition-title">{{ condition.label }}</span>
            <button mat-icon-button (click)="removeCondition(i)" class="remove-condition-btn">
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <!-- Dropdown for IN operator -->
          <mat-form-field *ngIf="condition.operator === 'IN'" appearance="outline" class="full-width">
            <mat-label>Chọn giá trị</mat-label>
            <mat-select [(value)]="condition.selectedValues" multiple>
              <mat-option [value]="'__SELECT_ALL__'" (click)="toggleSelectAll(condition)">
                <strong>Chọn tất cả</strong>
              </mat-option>
              <mat-option *ngFor="let option of condition.options" [value]="option">
                {{ option }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Text input for CONTAINS operator -->
          <mat-form-field *ngIf="condition.operator === 'CONTAINS'" appearance="outline" class="full-width">
            <mat-label>Nhập văn bản</mat-label>
            <input matInput [(ngModel)]="condition.textValue" placeholder="Tìm kiếm...">
          </mat-form-field>
        </div>
      </div>

      <!-- Apply Button -->
      <div class="filter-actions">
        <button mat-raised-button color="primary" (click)="applyFilters()" class="apply-filter-btn">
          Áp dụng
        </button>
      </div>
    </div>
  </div>
</ng-template>
